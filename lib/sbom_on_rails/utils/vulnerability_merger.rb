module SbomOnRails
  module Utils
    class VulnerabilityMerger
      def initialize
      end

      def run(json_string)
        data = JSON.parse(json_string)
        vuln_hash = {}
        vuln_list = data["vulnerabilities"]
        vuln_list ||= []
        vuln_list.each do |vuln_json|
          vuln = SbomOnRails::Sbom::JsonVulnerability.new(vuln_json)
          if vuln_hash.has_key?(vuln.vuln_id)
            vuln_hash[vuln.vuln_id] = vuln_hash[vuln.vuln_id].merge(vuln)
          else
            vuln_hash[vuln.vuln_id] = vuln
          end
        end
        data["vulnerabilities"] = vuln_hash.values.map(&:as_sbom_structure)
        JSON.generate(data)
      end
    end
  end
end